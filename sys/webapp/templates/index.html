{% extends "layout.html" %}
{% block stylesheet %}
    <link rel="stylesheet" href="{{ url_for('static', filename="css/index.css") }}">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/pikaday/css/pikaday.css">

{% endblock %}

{% block content %}
    <section class="contact-clean">
        <form novalidate id="method-request" method="post">
            <h2 class="text-center">Cerco ragazza</h2>
            <div class="mb-3">
                <input class="form-control" type="text" name="plate" placeholder="Targa" autocomplete="off">
            </div>
            <div class="form-group mx-sm-3 mb-2">
                <input class="form-control where" id="myInput" style="text-transform:uppercase" type="text" name="where_start" placeholder="Partenza">
                <input class="form-control where" style="text-transform:uppercase" type="text" name="where_end" placeholder="Arrivo">
            </div>
            <div class="mb-3">
                <textarea class="form-control" name="textarea" cols="30" rows="10"></textarea>
            </div>
            <div class="mb-3">
                <input class="form-control date" type="text" name="date_start" id="date" placeholder="Date" autocomplete="off">
                <input class="form-control date" type="text" name="date_end" placeholder="Date" autocomplete="off">
            </div>
            <div class="mb-3">
                <input class="form-control" type="text" name="goods" placeholder="Goods" autocomplete="off">
            </div>
            <div class="mb-3">
                {% for message in get_flashed_messages() %}
                    {% if message.startswith('You') %}
                        <div class="flash"><p class="alert alert-danger">{{ message }}</p></div>
                    {% else %}
                        <div class="flash"><p class="alert alert-success">{{ message }}</p></div>
                    {% endif %}
                {% endfor %}
            </div>
            <div class="mb-3">
                <button class="btn btn-primary" type="submit">send </button>
            </div>
        </form>
    </section>

    <script defer>
        function autocomplete(inp, arr) {
            //arr.forEach(element => {
            //    console.log(element);
            //});
            /*the autocomplete function takes two arguments,
            the text field element and an array of possible autocompleted values:*/
            let currentFocus;
            /*execute a function when someone writes in the text field:*/
            inp.addEventListener("input", function (e) {
                let a, b, i, val = this.value;
                /*close any already open lists of autocompleted values*/
                closeAllLists();
                if (!val) {
                    return false;
                }
                currentFocus = -1;
                /*create a DIV element that will contain the items (values):*/
                a = document.createElement("DIV");
                a.setAttribute("id", this.id + "autocomplete-list");
                a.setAttribute("class", "autocomplete-items");
                /*append the DIV element as a child of the autocomplete container:*/
                this.parentNode.appendChild(a);
                /*for each item in the array...*/
                let to_see = 0;
                for (i = 0; i < arr.length; i++) {
                    /*check if the item has the same letters as the text field value:*/
                    if (arr[i].toUpperCase().includes(val.toUpperCase())) {
                        to_see++;
                        if(to_see <= 10) {
                            /*create a DIV element for each matching element:*/
                            b = document.createElement("DIV");
                            b.innerHTML = arr[i].substr(0, val.length);
                            b.innerHTML += arr[i].substr(val.length);
                            b.innerHTML = b.innerText.replace(val, "<strong>" + val + "</strong>");
                            /*insert a input field that will hold the current array item's value:*/
                            b.innerHTML += "<input type='hidden' value='" + arr[i] + "'>";
                            /*execute a function when someone clicks on the item value (DIV element):*/
                            b.addEventListener("click", function (e) {
                                /*insert the value for the autocomplete text field:*/
                                inp.value = this.getElementsByTagName("input")[0].value;
                                /*close the list of autocompleted values,
                                (or any other open lists of autocompleted values:*/
                                closeAllLists();
                            });
                            a.appendChild(b);
                        }
                    }
                }
            });
            /*execute a function presses a key on the keyboard:*/
            inp.addEventListener("keydown", function (e) {
                let x = document.getElementById(this.id + "autocomplete-list");
                if (x) x = x.getElementsByTagName("div");
                if (e.keyCode === 40) {
                    /*If the arrow DOWN key is pressed,
                    increase the currentFocus variable:*/
                    currentFocus++;
                    /*and and make the current item more visible:*/
                    addActive(x);
                } else if (e.keyCode === 38) { //up
                    /*If the arrow UP key is pressed,
                    decrease the currentFocus variable:*/
                    currentFocus--;
                    /*and and make the current item more visible:*/
                    addActive(x);
                } else if (e.keyCode === 13) {
                    /*If the ENTER key is pressed, prevent the form from being submitted,*/
                    e.preventDefault();
                    if (currentFocus > -1) {
                        /*and simulate a click on the "active" item:*/
                        if (x) x[currentFocus].click();
                    }
                }
            });

            function addActive(x) {
                /*a function to classify an item as "active":*/
                if (!x) return false;
                /*start by removing the "active" class on all items:*/
                removeActive(x);
                if (currentFocus >= x.length) currentFocus = 0;
                if (currentFocus < 0) currentFocus = (x.length - 1);
                /*add class "autocomplete-active":*/
                x[currentFocus].classList.add("autocomplete-active");
            }

            function removeActive(x) {
                /*a function to remove the "active" class from all autocomplete items:*/
                for (let i = 0; i < x.length; i++) {
                    x[i].classList.remove("autocomplete-active");
                }
            }

            function closeAllLists(elmnt) {
                /*close all autocomplete lists in the document,
                except the one passed as an argument:*/
                const x = document.getElementsByClassName("autocomplete-items");
                for (let i = 0; i < x.length; i++) {
                    if (elmnt !== x[i] && elmnt !== inp) {
                        x[i].parentNode.removeChild(x[i]);
                    }
                }
            }

            /*execute a function when someone clicks in the document:*/
            document.addEventListener("click", function (e) {
                closeAllLists(e.target);
            });
        }
    </script>

    <script defer>
    let lista = [];
        (async () => {
            const response = await fetch(
              'https://parseapi.back4app.com/classes/Worldzipcode_IT?limit=1000000000000&keys=adminCode2,placeName,postalCode',
              {
                headers: {
                  'X-Parse-Application-Id': 'pX9BoL9aKBRWdqVp0fOmBK5ktvIiVht4lLz1tBEH', // This is your app's application id
                  'X-Parse-REST-API-Key': 'wcI3cIhmOdFGPawZ39Ik6j5NlPykVkrwxmqx9ZnS', // This is your app's REST API key
                }
              }
            );
            const data = await response.json();

            data['results'].forEach((element) => {
                lista.push(`${element["placeName"].toUpperCase()} (${element["postalCode"]}) ${element["adminCode2"]}`)
            });

            Array.from(document.getElementsByClassName("form-control where")).forEach((element) => {
                autocomplete(element, lista);
            });
          })();
    </script>

    <script src="https://cdn.jsdelivr.net/npm/pikaday/pikaday.js"></script>

    <script>
        Array.from(document.getElementsByClassName('form-control date')).forEach((element) => {
            new Pikaday({
                field: element,
                format: 'D/M/YYYY',
                minDate: new Date(),
                toString(date, format) {
                    const day = date.getDate();
                    const month = date.getMonth() + 1;
                    const year = date.getFullYear();
                    return `${day}/${month}/${year}`;
                }
            });
        });
    </script>

    <script>
        document.querySelector('#method-request').addEventListener('submit', (e) => {
           e.preventDefault();
           Array.from(document.getElementsByClassName('form-control where')).forEach((element) => {
              if(!(lista.includes(element.value))) {
                  element.value = null;
              }
           });
           document.querySelector('#method-request').submit();
        });
    </script>
{% endblock %}